<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>📷 LOT Scanner</title>
  <style>
    video {
      width: 90%;
      max-width: 500px;
      border: 2px solid #444;
      border-radius: 10px;
    }
    #output {
      font-size: 18px;
      color: green;
      margin-top: 10px;
    }
    button {
      margin-top: 10px;
      padding: 8px 16px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h2>📷 LOT Scanner</h2>
  <video id="video" autoplay></video><br>
  <button id="start">📡 Kamerayı Başlat</button>
  <p id="output">📄 Barkod bekleniyor...</p>

  <script src="https://unpkg.com/@zxing/browser@latest"></script>
  <script>
    const startButton = document.getElementById('start');
    const videoElement = document.getElementById('video');
    const output = document.getElementById('output');

    let selectedDeviceId;
    let codeReader;

    async function initScanner() {
      output.innerText = "📡 Kamera başlatılıyor...";
      try {
        const devices = await ZXing.BrowserCodeReader.listVideoInputDevices();
        selectedDeviceId = devices.find(device => device.label.toLowerCase().includes('back'))?.deviceId || devices[0]?.deviceId;

        if (!selectedDeviceId) {
          output.innerText = "❌ Uygun kamera bulunamadı.";
          return;
        }

        codeReader = new ZXing.BrowserMultiFormatReader();
        codeReader.decodeFromVideoDevice(selectedDeviceId, videoElement, (result, err) => {
          if (result) {
            const barkod = result.getText();
            output.innerHTML = `✅ Barkod: <br><b>${barkod}</b>`;
            sendToSheet(barkod);
            codeReader.reset(); // Tek seferlik okuma
          }
        });
      } catch (err) {
        output.innerText = "❌ Kamera açılamadı: " + err;
      }
    }

    async function sendToSheet(barcode) {
      try {
        await fetch("https://script.google.com/macros/s/AKfycbxTe2DjepcMKZZoFCrjZFC3iihHfyB9RrbH9sv38xsKw8hmOzwx4FmdkqjYb8MfjFg/exec", {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: "barkod=" + encodeURIComponent(barcode)
        });
        output.innerHTML += "<br>📤 Google Sheets'e gönderildi.";
      } catch (e) {
        output.innerHTML += "<br>❌ Sheets'e gönderme hatası.";
      }
    }

    startButton.addEventListener("click", initScanner);
  </script>
</body>
</html>
